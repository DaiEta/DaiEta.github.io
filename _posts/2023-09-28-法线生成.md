---
layout:     post
title:      法线生成
subtitle:   法线的生成算法
date:       2023-09-28
author:     Eta
header-img: img/eta_1.jpg
catalog: true
tags:
    - CG
---

## 法线图作用

法线纹理是用于增加模型表面的光照细节，通常我们的几何体会设置光照模型，着色器则会根据这个光照模型以及光源在渲染时修改像素颜色。

3D卡片本身也具有法线，但由于是一个平面并且纹理也是二维的，所以其正面的所有点的法线都是同一方向的，效果显然会比较单一。

一张二维的纹理图仅有x和y两个维度，若能给其加上第三个纬度z，那么则可以具备三维的信息了。法线图即是根据这个原理来发挥作用的。

## 计算灰度图

法线是垂直于某个平面的向量，计算法线需要知道平面的起伏，因此需要一个纹理图对应的高度图，代表每个像素的高度。如果没有高度图，也可以用灰度图代替，灰度图就是用纹理图的rgb三个颜色分量计算出加权平均值。

$$ grayColor = color.r * 0.2126 + color.g * 0.7152 + color.b * 0.0722 $$

## 计算切平面

得到三维信息后，求一个点的法线需要先求得该点的切平面，法线则垂直于该切平面。因此只需要分别求得该点在x方向上的切线方向以及y方向上的切线即可确定一个切平面。

当需要求一个点的xy方向切线的时候，即求出该点在此方向上的斜率，这需要和它相临的点进行计算。两个点越接近，结果越精确。这里由于图像计算时是离散的点，因此直接使用差分法得到每个点在两个方向上的切线

$$ \vec{T_x} = (\Delta, 0, dx) \\
   \vec{T_y} = (0, \Delta, dy) $$

其中$\Delta$为步长，$dx$为x方向的灰度值差，$dy$为y方向的灰度值差

## 计算法向量

根据以上得到的两个切线向量，通过叉乘即可直接得出法线向量为

$$ 
\begin{aligned}
\vec{N} &= \vec{T_x} \times \vec{T_y} \\
&= (-\Delta * dx, \Delta * dy, \Delta ^ 2)
\end{aligned}
$$

归一化向量可得法线的分量为

$$
\begin{aligned}
&\vec{N_x} = \frac{-dx}{\sqrt{dx^2 + dy^2 + \Delta^2}} \\
&\vec{N_y} = \frac{dy}{\sqrt{dx^2 + dy^2 + \Delta^2}} \\
&\vec{N_z} = \frac{\Delta}{\sqrt{dx^2 + dy^2 + \Delta^2}}
\end{aligned}
$$

## 存储为法线纹理

得到每个点的法线向量后，我们需要将其存储为图片，使用图片的rgb通道分别存储法线的xyz分量。由于rgb只能存储正的值，而法线向量的xy分量可能有负值，因此需要进行转换，将xy标准化到区间[0, 1]

$$ 
\begin{aligned}
&R = (\vec{N_x} + 1) / 2 \\
&G = (\vec{N_y} + 1) / 2 \\
&B = \vec{N_z}
\end{aligned}
$$
